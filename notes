#!/bin/bash

SCRIPTPATH="$(dirname "`readlink -f $0`")"
source "$SCRIPTPATH/common.sh" || exit 1

SCRIPT_VERSION=3
expect_common_version 1
load_config
check_config NOTEDIR="$HOME/notes" DOCDIR="$HOME/.vim/doc"
need_binaries vim grep sed tr

tag_lookup="personal-notes"

function populate_notes {
    topic="$1"
    filename="$topic.txt"
    cat > "$NOTEDIR/$filename" << EOF
" vim: filetype=help foldmethod=marker foldmarker=<<<,>>> modifiable noreadonly

*${topic}*
EOF
}

if [ ! -L "$DOCDIR/$(basename "$NOTEDIR")" ]; then
    mkdir -p "$DOCDIR"
    ln -s "$NOTEDIR" "$DOCDIR"
fi

if [ ! -d "$NOTEDIR" ]; then
    mkdir -p "$NOTEDIR"
    populate_notes "$tag_lookup" "notes"
fi

handle_topics() {
    search="[a-zA-Z0-9_-]*"
    grep -r -h -o -i -e "\*${search}\*" "$NOTEDIR"/* | sed -e 's/\*//g' | tr '[A-Z]' '[a-z]' | tr '\n' ' '
    echo ""
    exit $?
}

handle_new() {
    tag_lookup="$(basename "$1" .txt)"
    if [ ! -e "$NOTEDIR/$tag_lookup.txt" ]; then
        populate_notes "$tag_lookup"
    fi
}

lookup_tag() {
    single_tag=$1
    search_hits=$(grep -r -i -e "\*${single_tag}.*\*" "$NOTEDIR"/* | wc -l)
    if [ $search_hits -lt 1 ]; then
        echo "no tags with query '$single_tag'"
        exit 1
    elif [ $search_hits -gt 1 ]; then
        echo "ambiguous query, matches $search_hits tags"
        exit 1
    fi
    tag_lookup="$single_tag"
}

handle_options \
    "default:           lookup_tag            " \
    "-n,--new,      1,  handle_new            " \
    "  ,--topics,   0,  handle_topics         " \
    ---                                         \
    "$@"

exec vim -c ":helptags $DOCDIR | h $tag_lookup | only"
