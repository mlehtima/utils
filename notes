#!/bin/bash

SCRIPTPATH="$(dirname "`readlink -f $0`")"
source "$SCRIPTPATH/common.sh" || exit 1

load_config
check_config NOTEDIR="$HOME/notes" DOCDIR="$HOME/.vim/doc"
need_binaries vim grep sed tr

if [ "$1" == "--autocomplete" ]; then
    search="[a-zA-Z0-9_-]*"
    if [ $# -gt 1 ]; then
        search="${2}${search}"
    fi
    grep -r -h -o -i -e "\*${search}\*" "$NOTEDIR"/* | sed -e 's/\*//g' | tr '[A-Z]' '[a-z]' | tr '\n' ' '
    exit $?
fi

if [ ! -d "$NOTEDIR" ]; then
    mkdir -p "$NOTEDIR"
    cat > "$NOTEDIR/notes.txt" << EOF
" vim: filetype=help foldmethod=marker foldmarker=<<<,>>> modifiable noreadonly

*personal-notes*
EOF

fi

if [ ! -L "$DOCDIR/$(basename "$NOTEDIR")" ]; then
    mkdir -p "$DOCDIR"
    ln -s "$NOTEDIR" "$DOCDIR"
fi

tag_lookup="personal-notes"
if [ $# -gt 0 ]; then
    single_tag=$1
    search_hits=$(grep -r -i -e "\*${single_tag}.*\*" "$NOTEDIR"/* | wc -l)
    if [ $search_hits -lt 1 ]; then
        echo "no tags with query '$single_tag'"
        exit 1
    fi
    tag_lookup="$single_tag"
fi
exec vim -c ":helptags $DOCDIR | h $tag_lookup | only"
